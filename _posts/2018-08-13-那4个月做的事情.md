---
layout:     post
title:      那4个月做的事情
subtitle:   what I did in that four months
date:       2018-08-13
author:     宸笙
catalog: true
tags:
    - 工作
---

## 起
2018年3月底，因为内外部的原因，我离开了国内某知名后端云服务平台，开始了下一段的旅程。
## 选择？
坦白说，在后端云平台的2年里，我几乎都是专注于公司的事情，从实习，到正式负责SDK，甚至包括答疑与技术支持等很多细节(人少的创业公司加上后面的坚持，也和自己的性格有关，不好拒绝)，到后面SDK逐步稳定，流程也逐渐完善，自己也慢慢会困惑，很多时候不用怎么看代码也能快速定位开发者的问题，前后端的问题也都能大致理解，我是不是在自己的舒适区有点久了，加上其他原因，使得自己萌生去意；
不过自己也很久没看外面的世界了，两年间我也没面试过，不过SDK的岗位确实不多，刚好一个朋友说他那边的SDK挺不规范，问题挺多，有时一些问题也会问下我这边的处理经验，问有没有兴趣过去，私下说坑多，我笑说我想按照我这边成型的用户量多的SDK的标准尽力去逐步改造，他也说你有兴趣就好了，所以从内退到面试，很流畅；
新公司是一家做和地铁公交类相关业务的和比如广州地铁羊城通等都有合作关系的企业，而SDK正是基于云卡云码业务的封装，提供给内外部接入使用。
## 经过
### 初印象
入职第一天部门老大(架构师)向我介绍了公司的主要业务和SDK(云卡云码)的核心地位(公司几大核心产品用到)，我也想快速熟悉公司产品和现有SDK的问题(个人经验--快速熟悉一个产品和业务的捷径就是看过往历史工单，问题反馈和文档)，老大也同意我在一定程度的熟悉后改善和优化SDK。
### 新接手SDK
这个也是很多人会遇到的，刚入职多半接手的是现有的项目，如果是SDK，还有很多用户在用的线上版本，所以平滑快速上手是很重要的，不过这边的SDK因为文档零散不规范，代码也无规范可言(因为朋友先和我交底倒也不意外和不抵触，想尽力规范化)，而且项目中一些核心的加解密和卡数据都放在了jni的so文件，java层基于对业务的封装和作为胶水层缝合业务方和本地的卡数据，在Api的规模和代码量上倒是比老东家少了一个数量级，我大致花了一周时间(有的毫无注释的代码很难逆向阅读)和同事请教业务和梳理业务并输出文档(后面也能验证让新手快速熟悉业务)，后续就慢慢开始一些问题的改进了；
### SDK的问题
这可能才是作为程序员的你关注的，或者说你关注的是好的SDK应该是怎样的，在笔者写过的blog中有写到较好设计的SDK的一些细节，不过这里也可以列出一些反例，当然初学者直接看反例代码可能会被误导；
1. 代码层面<br><br>
听说SDK的第一个版本脱胎于外包之手，所有也难怪在代码层面几乎把常见的错误都犯了，但是长达一年多的时间里没持续改进而任之逐渐腐化就有点不可取了；
* 对内(同事，接手人)<br>
虽说较好设计和维护的SDK应该是代码逻辑清晰，但至少也应尽量做到较好的编码规范(和经验能力没多大关系，和编码习惯等有关)，但是手头看到的代码几乎都是很混乱的，基本表现为：

  > 常见的命名等都不说了，你能想象到；

  > 缺少必要的注释，僵尸代码(临时测试添加，后续没及时去掉，后续同事又不敢删)遍野，充斥着大量面条代码(一条线写全部逻辑)，几乎没有复用，更谈何设计(稳健规范的代码后再谈设计)，接手的同事有的确实看不懂就另写一套自己能看得懂和维护的；

  > 充斥大量冗余代码，重复的功能片段，如下载卡数据后更新到本地甚至多次通过复制插入到不同的方法中，连基本的复用都没做到，比如其中一个update接口，我基本稍作修改就只能把接近400行的代码拆分复用减少为20来行，这样定位问题也很方便，不会向之前那样出现同样的代码报错还要分是哪个重复的区域的，而一些因为代码基本功不扎实导致的看似复杂不太好改的代码也很典型，基本功相对过关一点，都不用写的那么麻烦；

  > 一对Sout打印竟没Tag，看到Logcat到处的日志飞舞，即使看出来了大致问题，问题来了，不同类的可能有重复的Sout，我怎么知道是哪里打出来的呢，在这种场景下你才会体会到Tag的作用；

  > 个人觉得代码细节是代表一个人的细节思考和编码习惯的，先不要说什么设计，解耦，甚至现在动辄就说到的架构，先把基础的代码写端正先，就像先把字写清楚易读才学书法，在一次因为临时需求需要紧急加班，同事和我调试一个bug，同事说先这样写规避，我说这样很随意会坑到接手的人，他说那你接手的时候没被坑到吗，言下之意是由他去了，真想别人说的有的小作坊写代码就如搅*棍，每个人来一下；


* 对外(用户，开发者)<br>

  SDK的特殊之处在于你的使用者并不是终端用户，而是那些服务于终端用户的程序员们，所以在我开来，他们使用你开发的SDK过程中，两个媒介是很重要的：

  (1) code -- SDK中的API

  对于SDK开发来说，怎么强调对外的API(接口)都是不过分的，作为程序员来说，你使用一些三方库大部分时间还是和library的API打交道的，对你开发的SDK和使用者也是同样的道理，在我看来，SDK开发者和使用者的沟通语言就是API了，API的难易程度和是否会误用，是否高效，是否符合直觉都是决定你SDK的质量和受众的因素，特别是对外的SDK(一经发布，长期维护)，功能重复或相悖的API甚至会贻笑大方，下面列举下我接手的SDK在这方面的问题：

  a. 对外接口含义较混乱<br>
  很多SDK偏重对业务的封装，先说封装做了什么和封装的好处：<br>
  (1) 封装对后端RestApi接口的调用
在很多情况下，一些平台性的后端API都是细粒度的，而对于开发者的一些简单业务流程可能是组合了多个细粒度的RestAPI，如果SDK能做一定程度的封装(如果你能看到一些开放平台的客户端SDK和RestAPI基本能看到几乎很难见到接口是1对1的，在力求简单易用的前提下，客户端SDK往往不需要做到同时支持较多细粒度的需求这样灵活强可定制)，这样其实对接入方来说是好事，也符合最少知识原则，而一些对比如Android平台裸Api的封装的SDK如网络库等也是类似，在移动互联网的早期，基本知名的SDK厂商都声称一行代码即可进行推送或者云服务之类的，让开发者比较省心；<br>
(2) 相比如调RestApi的繁琐，调用客户端SDK是相当便捷的，客户端SDK帮你做好了接口拼接，序列化和反序列化，数据缓存，用一定的设计模式帮你简化调用过程和减少出错(误用)的几率，如果你调后端Api呢，域名，接口地址，请求头，请求格式，序列化，缓存，请求数据的安全性加密，调用成本还是挺高的，所以其实也会自己提炼封装一个库出来，或在这个角度说，SDK无疑是对后端API的封装；<br>
(3) 还有一个你可能忽略的细节，就是SDK或者好的中间件(library)其实还帮我们缝合了很多我们本不太容易做的事情，帮我们封装了一些复杂的概念和流程，进而暴露一些简单的数量少的或者我们熟知的概念或API，这就需要在中间的我们去设计SDK的时候，在不影响正确性的前提下，适当隐藏一些晦涩的概念并提供开发者以简单的API，举个例子：
在笔者从事过的后端云平台，它的初衷就很好体现了这一点，很多人只会客户端开发而不会后端开发，那么一些外包也不太好做，要写一个App实现自己的idea还要跨过后端服务器配置，数据库设计，运维等这些耗时费精力的难关，链路太长，而且这些都是每个开发者重复遇到的，业务上呢，用户模型，地理位置服务，IM服务，推送服务，短信服务，这些不是很多App的共性功能吗。，那么有没有一种方式，你只管写你的客户端，后端这些麻烦事我(平台)帮你做了呢，当然平台需要做的事情就比较多了，在服务器的运维和数据库上，要在web端帮开发者封装复杂功能并预留通用配置接口(开关)，因为开发者的数据库都是放平台上的，所以要提供类似workBentch的类似crud的查询功能(为了方便开发者使用可视化GUI)，那么在客户端要怎么去操作服务端的这些对象(数据)和功能呢，你可能注意到我说对象了，对的，用ORM的思路会不会比较巧妙，相当于客户端操作的只是对象，这些对他们都是日常司空见惯的，想比如常用的ORM库，区别只是在于，传统ORM映射到的是本地数据库如sqlite，而这种思路下的就是映射到网络平台上的数据库了，所以需要耗时异步回调，在实践中，也发现用ORM的方式能较大符合开发者的直觉；当然你也可以思考下ORM本身就是一把利器，初衷可能是一些层次较低的开发者不会正确使用sql语句或容易出错，那么ORM的出现使得这些程序员也能做到本来不太容易做到的事情，但是同时也大大提高了开发效率，这些思路都是类似的，好的SDK在中间能帮你化繁为简，比如说到后端云SDK，你可能会好奇一些关联查询和复合查询怎么做呢，用对象的方式也是可以的，而且能通过流式API来大大简化；
而在我手头的这份SDK，API的含义有的还是比较模糊，虽说大体上分云卡云码两大功能，但是仍有一些比如update更新卡数据的操作，其实这些基本可以做到SDK内部处理，或者封装出更合乎用户的直觉习惯的业务名称，尽量降低开发者的心智负担，同样作为程序员，在使用一些不太还三方库的时候各种纠结疑惑，相比你也曾体会过；<br>
还有一个问题，API的划分凌乱，看到代码和API结构后我猜想最初SDK是只有云卡的业务，所以门面类叫CloudCard，慢慢公司新增了云码业务，业务API很多都在该类中，该类职责就很不单一了，而云码的很多操作有的是和云卡分开的，甚至CloudCard的init方法和云码无关，后续不管是维护接手还是定位开发者的问题都很乱；<br>
另外，就是诡异的API，同时存在Callback参数和返回值，着实令人忍俊不禁，这也会让开发者十分困惑，方法执行完成的时机是？<br>
b. 对interface和 abstract class的取舍不当
你可能最早在学校遇到这样的题目或者是在被面试问到抽象类和接口的区别，但只不过是记得概念上的区别，这里先不说java8开始interface可以有方法的默认实现，在实际中，看到SDK的回调接口都是interface，有点SDK从业经验即可得知SDK后面会很麻烦，只要在该接口新增的方法，开发者升级SDK，都必须强制实现，这点体验很不好，而在一些成熟的SDK基本都是用抽象类实现的，比如后端云服务SDK；当然，我们不妨看下AndroidSDK，用interface声明的比较少，除了万年不变的Runnable，而其他如AsyncTask等都是abstract class，是因为很难保证后续一直不变动，而用abstract class 在一定程度支持了变动的自由，如果变化程度很高的呢，那就是普通的class了；<br>
c. 盲目为了接口复用(偷懒)导致的窘境<br>
这点是看到我才会总结到的，在手头的这份SDK，会有比如开卡applyCard和清卡cleanCard操作，前者用的回调接口是CardCallback，传Card对象，但是后者用CardCallback接口就有点诡异了，结果代码里面生生回传了一个null，开发者直接拿去用很容易App就崩溃了，这点是大忌，本来没有共性的API没必要用同一个回调接口，何况是回调参数本来区别较大；<br>
d. 接口呆板，难用<br>
在这个版本的SDK能看到数个参数有十多个的接口，着实令人费解，后端的平台接口存在这个问题也可以理解，我和同事用Builder改善下就可以了呀；<br>
e. 伴随着不清晰的业务变动的貌似重复的接口
<br>
f. 回调的线程问题 <br>
一般API很多都经过耗时异步都在子线程运行，早期的那种会block住主线程需要开发者手动创建线程的现在慢慢少了，但是帮开发者切换是不难的，笔者有一篇讲到，结果我发现全部没做，接入的App部门每次都是自己用Handler切回去的，另外就是有的接口存在block住UI线程的问题；<br>
g.糟糕的错误码设计<br>

  (2) else -- Demo & 文档 & 教程 & 社区 & 工单

    Demo，文档缺失或鲜有作用
    * 文档较为粗糙，后面的继续在此基础上渐行渐远；
    * Demo只有简单的一些代码段；
    * 有的文档通篇讲交通二维码之类云云，学院派甚重，但对理解业务几乎没有作用，甚至会被带偏；
    * 虽然有工单流程，但是整体沟通成本太大，每次都需要向(终端)用户拿日志，其实这些可以做到上报的；
    * 使用范围相对有限，几乎没什么社区的概念；
2. 流程方面<br>
开发和发版流程，比如：
    > 刚到公司看到每次对接一个企业客户，比如羊城通，需要对方提供包名，然后C开发同事去修改C的代码(因为需要去创建目录存放卡数据，目录名就由包名决定)，然后用户报名变动每次都要这边的同事手动修改，SDK这边人工编译成so库发给用户，这明显对程序员有点难忍的，几乎不用多年的所谓软件领域的悟性也能想到提供类似初始化的接口由开发者传入，SDK做个中转传到native岂不一本万利，而SDK这一年多来都没有同事意识到或者尝试修改；

    > 对外的SDK需要用混淆，既有的SDK用eclipse默认的proguard，但几乎没有什么混淆规则和混淆字典，被逆向阅读的难度很低，另外就是不管是打jar包还是build成so库，同事每次都重复人工，虽说他也说慢慢转到AS开发，我说你先用批处理文件.bat处理吧，后面他转到AS后，我带他用gradle task逐步改善，在一个AS工程中，SDK的开发，测试，打包，编译so库都可以进行，一键build，之前的人工重复复制，敲命令确实低效难忍，也很容易出错；
  3. 文档和周边细节
### 一些经过
* 我做的事情<br>
既然决定是来逐步改造，还是耐心梳理一些历史bug和流程，做的事情基本如下：<br>
(1) 对内梳理SDK内部文档，使得一个新来的同事，即使没有SDK从业经验，也能在一天内快速熟悉，其中包括了业务流程文档和一些纠偏，另外附有SDK各个API的调用时序图，重要结构的UML图等，虽然花了几天，但我相信这些是比单纯写代码解bug更有长远作用的；<br>
(2) 对外梳理SDK快速入门和详细文档，均用marddown写，完善使用教程和Demo；<br>
(3) SDK内部的代码尽量逐步改造；<br>
(4) SDK的开发流程尽量做到脚本化；<br>
(5) 海南通，翼支付等项目的SDK定制和技术支持；<br>
(6) SDK的通用化改造；
### 为什么要离开
总会归结到这个问题，也是要问自己的，走的时候CTO说你大致说道的问题是客观存在也会马上着手解决的，希望挽留之类的，说毕竟专注做SDK的不多，不过我还是决定想要走，部门也是公司核心，福利好，类似大公司稳定，那为什么呢？
1. 非技术主导的一些习惯，需求模糊和蔓延
非技术的lingdao主导技术，需求没理清便接下来，做海南通的项目，本说好是一个城市，后面临时修改为海南全省，一下子前后端的同事全都通宵加班，平时慢悠悠，晚上来个通宵加班，发给图到dingding群，附上决战今夜。。。
2. 习惯(氛围？)导致的低效，和后端的同事对接一个接口要一天
不管在学校实验室和师兄合作还是在老东家都不会这样，甚至后端同事因为看不懂代码来问我后端的逻辑，同步等待，着实阻塞；
3. 队友，房贷的30+中年人居多，使用全然不顾文档就甩锅的App部门
因为公司比较稳定，很多队友都是有了房贷的准30和30+的人，很少保持持续学习，公司后端有用所谓先进的微服务，也有jsp，servlet，而上班时间很多在谈古今时事逍遥自在，后端的一个高手(和他对接过很顺畅)一走，整个后端乱套，一些打我几岁的同事研究起了养生，我才24岁，我不该这样，没有看不惯，只是觉得我应该有别的方式去过我的二十几岁；App部门常年不看文档就甩锅SDK部门，这边经常帮那边解决说长达一周多未解的bug，基本都是基础问题，而在一次协调解决工单的过程中，毕竟App的业务基于SDK之上，我建议App部门的同事加点业务日志方便复盘和定位用户操作路径，毕竟SDK的日志对于用户还是比较粗疏的，当即被否定，估计是被觉得会加多其工作量；

4. 大地方的特征，跨部门协作效率相当低


## 思考--下一步

虽然看到了一些不太规范，不过还是没觉得枉来，毕竟自己也算经历了另一种体验，也是帮朋友解决掉了些问题；

* 经历很重要，快速成长多半是同样的时间内经历多点东西，不如去节奏快的互联网公司,有的仅仅是盛名之下其实难副；

* 特定平台或陌生领域的一些经历能促使你总结一些新的和经验，慢慢走出舒适区；

* 大平台或快速发展的平台；

